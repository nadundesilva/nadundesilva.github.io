name: Deployment Check

on:
    workflow_dispatch:
    deployment:
    schedule:
        - cron: 0 0 * * *

jobs:
    deployment-validation:
        strategy:
            matrix:
                browser:
                    - electron
                    - chrome
        name: Ubuntu Deployment Check (${{ matrix.browser }})
        runs-on: ubuntu-20.04
        steps:
            - name: Checkout
              uses: actions/checkout@v3
            - name: Setup Node.js
              uses: actions/setup-node@v2
              with:
                  node-version: "16.14.2"
            - name: Run End to End Tests
              run: |
                  npm ci
                  docker run -t -v "${PWD}:/test" -w /test cypress/included:7.4.0 \
                      run \
                    --headless \
                    --browser ${{ matrix.browser }} \
                    --reporter cypress-image-snapshot/reporter
            - name: Upload artifacts
              if: always()
              uses: actions/upload-artifact@v3
              with:
                  name: test-results-${{ matrix.browser }}
                  path: |
                      cypress/videos/
                      cypress/screenshots/
                      cypress/snapshots/**/__diff_output__/**

    links-check:
        name: Check Links in Website
        runs-on: ubuntu-20.04
        steps:
            - name: Checkout
              uses: actions/checkout@v3
            - name: Link Checker
              id: lychee
              uses: lycheeverse/lychee-action@v1.3.2
              with:
                  args: --verbose --no-progress https://nadundesilva.github.io/
                  fail: true
            - name: Upload Link Checker Report
              if: always()
              uses: actions/upload-artifact@v3
              with:
                  name: Link Checker Report
                  path: ./lychee/out.md

    website-audit:
        name: Run Website Audit
        runs-on: ubuntu-20.04
        steps:
            - name: Checkout
              uses: actions/checkout@v3
            - name: Setup Node.js
              uses: actions/setup-node@v2
              with:
                  node-version: "16.14.2"
            - name: Run Lighthouse Audit
              run: |
                  npm install -g @lhci/cli@0.9.x
                  lhci autorun
              env:
                  LHCI_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  VALIDATING_LIVE_SITE: "true"
            - name: Upload artifacts
              if: always()
              uses: actions/upload-artifact@v3
              with:
                  name: website-audit
                  path: ./lhci-out
