name: Deploy Site

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  run-unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Node.js
        uses: actions/setup-node@v1
        with:
          node-version: "14.17.6"
      - name: Install Dependencies
        run: |
          npm ci
      - name: Running Unit Tests
        run: |
          npm run test:ci
      - name: Upload Code Coverage to CodeCov
        uses: codecov/codecov-action@v2
        with:
          name: coverage-reports
          flags: unit-tests
          fail_ci_if_error: true
          verbose: true
      - name: Upload Code Coverage Report Artifacts
        uses: actions/upload-artifact@v2
        with:
          name: unit-tests-coverage
          path: coverage/

  run-e2e-tests:
    strategy:
      matrix:
        browser: [ electron, chrome ]
    name: Run E2E Tests (${{ matrix.browser }})
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Node.js
        uses: actions/setup-node@v1
        with:
          node-version: "14.17.6"
      - name: Install Dependencies
        run: |
          npm ci
      - name: Instrument Website for Code Coverage
        run: |
          npm ci
          npx nyc instrument --in-place --compact=false .
          npm run build
        env:
          BUILD_TYPE: test
      - name: Run End to End Tests
        run: |
          bash .github/scripts/run-e2e-tests.sh
        env:
          TEST_BROWSER: ${{ matrix.browser }}
          WEBSITE_BUILD_DIR: out
      - name: Upload Code Coverage to CodeCov
        uses: codecov/codecov-action@v2
        with:
          name: coverage-reports
          flags: e2e-tests
          fail_ci_if_error: true
          verbose: true
      - name: Upload Test Results Artifacts
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: e2e-test-results-${{ matrix.browser }}
          path: |
            cypress/videos/
            cypress/screenshots/
            cypress/snapshots/**/__diff_output__/**
      - name: Upload Code Coverage Report Artifacts
        uses: actions/upload-artifact@v2
        with:
          name: e2e-tests-coverage-${{ matrix.browser }}
          path: coverage/

  build-site:
    name: Build Site
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: "14.17.6"
      - name: Install Dependencies
        run: |
          npm ci
      - name: Build Site
        run: |
          npm run build
          touch ./out/.nojekyll
        env:
          PUBLIC_URL: https://nadundesilva.github.io
      - name: Upload Site
        uses: actions/upload-artifact@v2
        with:
          name: site
          path: out/
      - name: Upload Unit Tests Code Coverage Report
        uses: actions/upload-artifact@v2
        with:
          name: unit-tests-coverage
          path: coverage/

  links-check:
    name: Check Links in Website
    runs-on: ubuntu-20.04
    needs: build-site
    steps:
      - name: Download Site
        uses: actions/download-artifact@v2
        with:
          name: site
          path: _site/
      - name: Link Checker
        id: lychee
        uses: lycheeverse/lychee-action@v1.0.6
        with:
          args: --verbose --no-progress --base="./_site/" --exclude="^https?://www.googletagmanager.com/$" --exclude="^https://fonts.googleapis.com/$" --exclude="^https://fonts.gstatic.com/$" --exclude="^https://www.linkedin.com/in/nadundesilva$" --exclude="^https://twitter.com/nadunrds" ./_site/**/*.html
      - name: Upload Link Checker Report
        uses: actions/upload-artifact@v2
        with:
          name: Link Checker Report
          path: ./lychee/out.md
      - name: Fail on Link Errors
        run: exit ${{ steps.lychee.outputs.exit_code }}

  check-site-build:
    strategy:
      matrix:
        browser: [ electron, chrome ]
    name: Check Site Build (${{ matrix.browser }})
    runs-on: ubuntu-20.04
    needs: build-site
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Node.js
        uses: actions/setup-node@v1
        with:
          node-version: "14.17.6"
      - name: Install Dependencies
        run: |
          npm ci
      - name: Download Site
        uses: actions/download-artifact@v2
        with:
          name: site
          path: _site/
      - name: Run End to End Tests
        run: |
          bash .github/scripts/run-e2e-tests.sh
        env:
          TEST_BROWSER: ${{ matrix.browser }}
          WEBSITE_BUILD_DIR: _site
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: site-build-e2e-test-results-${{ matrix.browser }}
          path: |
            cypress/videos/
            cypress/screenshots/
            cypress/snapshots/**/__diff_output__/**

  deploy-site:
    name: Deploy Site
    runs-on: ubuntu-20.04
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    needs:
      - run-unit-tests
      - run-e2e-tests
      - build-site
      - links-check
      - check-site-build
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Download Site
        uses: actions/download-artifact@v2
        with:
          name: site
          path: _site/
      - name: Setup Node.js
        uses: actions/setup-node@v1
        with:
          node-version: "14.17.6"
      - name: Deploy
        uses: JamesIves/github-pages-deploy-action@4.1.1
        with:
          dry-run: ${{ github.event_name != 'push' }}
          branch: gh-pages
          folder: _site
          commit-message: |
            [Automated] Update Site (Source Commit: ${{ github.sha }})
